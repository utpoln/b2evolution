tinymce.PluginManager.add("b2evo_shorttags",function(r){var l,s,a,d=[],o=!1,i=[];i.push(16,17,18,19),i.push(20,27,45),i.push(33,34,35,36),i.push(37,38,39,40),i.push(91,92,93),i.push(112,113,114,115,116,117,118,119,120,121,122,123),i.push(144,145);function c(e){var t=r.dom;if(e!==s){if(u(),a=(s=e).getAttribute("data-evo-type"),t.bind(s,"paste cut",g),t.addClass(s,"evo_selected"),t.bind(s,"beforedeactivate focusin focusout",g),t.is(s,"img"))r.selection.select(s);else{var n=t.select("img:first",s);n.length?r.selection.select(n[0]):r.selection.setCursorLocation(s)}r.nodeChanged()}}function u(){var e=r.dom;s&&(e.unbind(s,"paste cut beforedeactive focusin focusout"),e.removeClass(s,"evo_selected"),a=s=null,r.selection.collapse())}function g(e){return e.stopPropagation(),!1}function p(e,l){for(var t=[],n=0;n<e.length;n++){!1===f(e[n])&&(d.push({shortTag:e[n],html:null,node:null,type:null,rendered:!1}),t.push("tags[]="+encodeURI(e[n])))}t.length?(t=t.join("&"),tinymce.util.XHR.send({url:r.getParam("anon_async_url")+"?action=render_inlines&p="+r.getParam("target_ID"),content_type:"application/x-www-form-urlencoded",data:t,success:function(e){var t=tinymce.util.JSON.parse(e);for(tag in t){var n=r.dom.create("div"),a=r.dom.createFragment(t[tag]),o=b(tag);r.dom.setAttrib(a.childNodes[0],"data-evo-tag",window.encodeURIComponent(tag)),r.dom.setAttrib(a.childNodes[0],"data-evo-type",o.type),n.appendChild(a);var i=f(tag);!1===i?d.push({shortTag:tag,html:n.innerHTML,node:n.childNodes[0],type:tagdata.type,rendered:!0}):!1===i.rendered&&(i.html=n.innerHTML,i.node=n.childNodes[0],i.rendered=!0)}l(t)}})):l()}function f(e){for(var t=d.length,n=0;n<t;n++)if(d[n].shortTag==e)return d[n];return!1}function t(e){for(var t,n=/(<span.*?data-evo-tag.*?>)?(\[(image|thumbnail|inline|video|audio):(\d+):?([^\[\]]*)\])(<\/span>)?/gi,a=[],o=[];null!==(t=n.exec(e));)t.index===n.lastIndex&&n.lastIndex++,a.push({shortTag:t[2],inlineType:t[3],linkId:parseInt(t[4]),other:t[5],openTag:t[1],closeTag:t[6]}),o.push(t[2]);p(o,function(e){e&&v()});for(var i=a.length,l=0;l<i;l++)if(a[l]&&!a[l].openTag&&!a[l].closeTag){var r=a[l].shortTag,s=f(r);if(!1!==s&&!1!==s.rendered)switch(a[l].inlineType){case"image":case"thumbnail":case"inline":e=e.replace(r,s.html);break;default:e=e.replace(r,'<span style="color: green;" data-evo-tag>'+r+"</span>")}}return e}function v(){var e=r.getContent();r.setContent(t(e))}function h(e,t){return t=t||"data-evo-tag",r.dom.getParent(e,"["+t+"]")}function e(e){var t=e.getAttribute("data-evo-tag");return!!t&&b(t)}function b(e){if(e){e=window.decodeURIComponent(e);var t=/\[(image|file|inline|video|audio|thumbnail):(\d+):?([^\[\]]*)\]/i.exec(e),n={tag:t[0],type:t[1],linkId:parseInt(t[2])};switch(n.type){case"image":(a=t[3])?((a=a.split(":"))[0]?"-"==a[0]?(n.caption=null,n.disableCaption=!0):(n.caption=a[0],n.disableCaption=!1):(n.caption=null,n.disableCaption=!1),a[1]?n.extraClass=a[1]:n.extraClass=null):(n.caption=null,n.extraClass=null);break;case"thumbnail":(a=t[3])?((a=a.split(":"))[0]&&-1!=["small","medium","large"].indexOf(a[0])?n.size=a[0]:n.size="medium",a[1]&&-1!=["left","right"].indexOf(a[1])?n.alignment=a[1]:n.alignment="left",a[2]?n.extraClass=a[2]:n.extraClass=null):(n.size="medium",n.alignment="left",n.extraClass=null);break;case"inline":var a=t[3];n.extraClass=a||null;break;default:n.options=t[3]}return n}return!1}this.selected=function(){return s},r.addButton("evo_image",{text:"[image:]",icon:!1,tooltip:"Edit image",onclick:function(){if(!r.getParam("target_ID"))return alert("Please save post first to start uploading files."),!1;if(!s||"image"!=a)return openModalWindow('<span class="loader_img loader_user_report absolute_center" title="Loading..."></span>',"80%","",!0,"Select image to insert","",!0),jQuery.ajax({type:"POST",url:r.getParam("modal_url"),success:function(e){openModalWindow(e,"90%","80%",!0,"Select image","")}}),!1;var e=function(e){return e.getAttribute("data-evo-tag")}(s);evo_item_image_edit(r.settings.blog_ID,e)},onPostRender:function(){var t=this;r.on("NodeChange",function(e){t.active("image"==a)})}}),r.addButton("evo_thumbnail",{text:"[thumbnail:]",icon:!1,tooltip:"Edit thumbnail",onclick:function(){if(!r.getParam("target_ID"))return alert("Please save post first to start uploading files."),!1;if(!s||"thumbnail"!=a)return openModalWindow('<span class="loader_img loader_user_report absolute_center" title="Loading..."></span>',"80%","",!0,"Select image to insert","",!0),jQuery.ajax({type:"POST",url:r.getParam("modal_url"),success:function(e){openModalWindow(e,"90%","80%",!0,"Select image","")}}),!1;var i=e(s);l=r.windowManager.open({title:"Edit Thumbnail",body:[{type:"listbox",name:"alignment",label:"Alignment:",values:[{text:"left",value:"left"},{text:"right",value:"right"}],value:i?i.alignment:"left"},{type:"listbox",name:"size",label:"Size",values:[{text:"small",value:"small"},{text:"medium",value:"medium"},{text:"large",value:"large"}],value:i?i.size:"medium"},{type:"textbox",name:"extraClass",label:"Additional class:",minWidth:500,value:i?i.extraClass:null}],buttons:[{text:"Update",onclick:function(){var e=l.find("#size")[0],t=l.find("#alignment")[0],n=l.find("#extraClass")[0],a="[thumbnail:"+i.linkId;a+=":"+e.value(),a+=":"+t.value(),a+=n.value()?":"+n.value():"";var o=f(a+="]");!1===o?p([a],function(e){for(var t=0;t<d.length;t++)if(d[t].shortTag==a){o=d[t];break}o&&(s?r.dom.replace(o.node,s,!1):r.insertContent(o.html),r.windowManager.close())}):(s?r.dom.replace(o.node,s,!1):r.insertContent(o.html),r.windowManager.close())}},{text:"Cancel",onclick:"close"}]})},onPostRender:function(){var t=this;r.on("NodeChange",function(e){t.active("thumbnail"==a)})}}),r.addButton("evo_inline",{text:"[inline:]",icon:!1,tooltip:"Edit inline",onclick:function(){if(!r.getParam("target_ID"))return alert("Please save post first to start uploading files."),!1;if(!s||"inline"!=a)return openModalWindow('<span class="loader_img loader_user_report absolute_center" title="Loading..."></span>',"80%","",!0,"Select image to insert","",!0),jQuery.ajax({type:"POST",url:r.getParam("modal_url"),success:function(e){openModalWindow(e,"90%","80%",!0,"Select image","")}}),!1;var t=e(s);l=r.windowManager.open({title:"Edit Inline",body:[{type:"textbox",name:"extraClass",label:"Additional class:",minWidth:500,value:t?t.extraClass:null}],buttons:[{text:"Update",onclick:function(){var e=l.find("#extraClass")[0],n="[inline:"+t.linkId;n+=e.value()?":"+e.value():"";var a=f(n+="]");!1===a?p([n],function(e){for(var t=0;t<d.length;t++)if(d[t].shortTag==n){a=d[t];break}a&&(s?r.dom.replace(a.node,s,!1):r.insertContent(a.html),r.windowManager.close())}):(s?r.dom.replace(a.node,s,!1):r.insertContent(a.html),r.windowManager.close())}},{text:"Cancel",onclick:"close"}]})},onPostRender:function(){var t=this;r.on("NodeChange",function(e){t.active("inline"==a)})}}),r.on("BeforeSetContent",function(e){e.content=t(e.content)}),r.on("PostProcess",function(e){e.get&&(e.content=function(e){e=e.replace(/(<span [^>]+data-evo-error[^>]+>(.*?)<\/span>)/gi,function(e,t,n){return n});for(var t=/(<span.*?data-evo-tag.*?>)?(\[(image|file|inline|video|audio|thumbnail):(\d+):?([^\[\]]*)\])(<\/span>)?/gi;null!==(m=t.exec(e));)m.index===t.lastIndex&&t.lastIndex++,m[1]&&m[6]&&(e=e.replace(m[0],m[2]));for(var n,a=r.dom.createFragment(e);n=a.querySelector("[data-evo-tag]");){var o=window.decodeURIComponent(n.getAttributeNode("data-evo-tag").value);n.parentNode.replaceChild(document.createTextNode(o),n)}var i=r.dom.create("div");return i.appendChild(a),i.innerHTML}(e.content))}),r.on("attachmentsLoaded",function(e){v()}),r.on("mousedown mouseup click touchend",function(e){var t=h(e.target);t?(e.stopImmediatePropagation(),e.preventDefault(),c(t)):u()},!0),r.on("keydown",function(e){r.dom;var t,n=r.selection;if(t=h(n.getNode()),s){if(8==e.which||46==e.which)return o=s,e.preventDefault(),!1;if(-1==i.indexOf(e.which))return e.preventDefault(),!1;switch(e.which){case 37:case 38:t.previousSibling&&n.setCursorLocation(s);break;case 39:case 40:if(t.nextSibling)return n.setCursorLocation(t.nextSibling),e.preventDefault(),!1}}else n.isCollapsed()||(range=n.getRng(),(t=h(range.endContainer))?(clonedRange=range.cloneRange(),n.select(t.previousSibling,!0),n.collapse(),tempRange=n.getRng(),clonedRange.setEnd(tempRange.endContainer,tempRange.endOffset),n.setRng(clonedRange)):(t=h(range.startContainer))&&(clonedRange=range.cloneRange(),clonedRange.setStart(t.nextSibling,0),n.setRng(clonedRange)))},!0),r.on("keyup",function(e){var t;r.dom;(t=h(r.selection.getNode()))?c(t):u(),o&&(function(e){s==e&&u(),r.undoManager.transact(function(){r.dom.remove(e)})}(o),o=!1)}),r.on("ResolveName",function(e){if(r.dom.getAttrib(e.target,"data-evo-tag")){var t=r.dom.getAttrib(e.target,"data-evo-type");e.name=t?"["+t+":]":"shorttag",e.stopPropagation()}else h(e.target)&&(e.preventDefault(),e.stopPropagation())}),r.on("dragstart",function(e){var t=h(e.target);if(t){c(t);var n=window.decodeURIComponent(t.getAttribute("data-evo-tag"));e.dataTransfer.setData("application/x-moz-node",e.target),e.dataTransfer.setData("text/plain",n),e.dataTransfer.effectAllowed="move"}else u()}),r.on("drop",function(e){var t=e.target,n=e.dataTransfer.getData("text/plain"),a=h(t);return a&&(t=a),"BODY"==t.tagName?(e.preventDefault(),!1):a&&n&&s?(e.preventDefault(),t.insertAdjacentHTML("beforebegin",n),r.dom.remove(s),v(),!1):void 0}),r.on("init",function(){var n=r.selection;r.on("BeforeSetContent",function(){var e,t=h(n.getNode());t&&(!t.nextSibling||h(t.nextSibling)?(e=r.getDoc().createTextNode(""),r.dom.insertAfter(e,t)):e=new tinymce.dom.TreeWalker(t.nextSibling,t.nextSibling).next(),n.select(e),n.collapse(!0))})})});